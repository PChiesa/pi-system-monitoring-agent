services:
  bop-agent:
    build: .
    container_name: bop-monitoring-agent
    restart: unless-stopped
    ports:
      - "${HEALTH_PORT:-8080}:8080"
    environment:
      - PI_SERVER=${PI_SERVER}
      - PI_DATA_ARCHIVE=${PI_DATA_ARCHIVE}
      - PI_USERNAME=${PI_USERNAME}
      - PI_PASSWORD=${PI_PASSWORD}
      - BOP_RWP=${BOP_RWP:-15000}
      - MASP=${MASP:-12500}
      - ANALYSIS_INTERVAL_MS=${ANALYSIS_INTERVAL_MS:-300000}
      - AGENT_MODEL=${AGENT_MODEL:-sonnet}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HEALTH_PORT=8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  postgres:
    image: postgres:17-alpine
    container_name: pi-simulator-db
    restart: unless-stopped
    environment:
      POSTGRES_DB: pi_simulator
      POSTGRES_USER: simulator
      POSTGRES_PASSWORD: simulator
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ./simulator/db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U simulator -d pi_simulator"]
      interval: 5s
      timeout: 3s
      start_period: 10s
      retries: 5

  simulator:
    build: simulator/
    container_name: pi-simulator
    restart: unless-stopped
    ports:
      - "${SIM_PORT:-8443}:8443"
    environment:
      - SIM_PORT=8443
      - SIM_AUTO_INTERVAL_MS=${SIM_AUTO_INTERVAL_MS:-600000}
      - DATABASE_URL=postgres://simulator:simulator@postgres:5432/pi_simulator
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:8443/admin/status"]
      interval: 10s
      timeout: 5s
      start_period: 10s
      retries: 3

volumes:
  pg_data:
