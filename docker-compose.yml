services:
  bop-agent:
    build: .
    container_name: bop-monitoring-agent
    restart: unless-stopped
    ports:
      - "${HEALTH_PORT:-8080}:8080"
    environment:
      - PI_SERVER=${PI_SERVER}
      - PI_DATA_ARCHIVE=${PI_DATA_ARCHIVE}
      - PI_USERNAME=${PI_USERNAME}
      - PI_PASSWORD=${PI_PASSWORD}
      - BOP_RWP=${BOP_RWP:-15000}
      - MASP=${MASP:-12500}
      - ANALYSIS_INTERVAL_MS=${ANALYSIS_INTERVAL_MS:-300000}
      - AGENT_MODEL=${AGENT_MODEL:-sonnet}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - HEALTH_PORT=8080
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      start_period: 15s
      retries: 3

  simulator:
    build: simulator/
    container_name: pi-simulator
    restart: unless-stopped
    ports:
      - "${SIM_PORT:-8443}:8443"
    environment:
      - SIM_PORT=8443
      - SIM_AUTO_INTERVAL_MS=${SIM_AUTO_INTERVAL_MS:-600000}
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://localhost:8443/admin/status"]
      interval: 10s
      timeout: 5s
      start_period: 5s
      retries: 3
